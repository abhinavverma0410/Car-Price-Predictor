<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Car Price Predictor</title>
    <link rel="stylesheet" type="text/css" href="../static/css/style.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="card">
                <div class="title">
                    <h1>Car Price Predictor</h1>
                </div>
                <div class="card-body">
                    <div class="sub-title">
                        <h5>This app predicts the price of a car you want to sell. Try filling the details below: </h5>
                    </div>
                    <br>
                    <form method="post" accept-charset="utf-8" name="Modelform" id="predictionForm">
                        <div class="form-group">
                            <label><b>Select the Vehicle Type:</b></label>
                            <select class="form-control" id="vehicle_type" name="vehicle_type" required
                                onchange="updateBrands()">
                                <option value="" disabled selected>Select Vehicle Type</option>
                                {% for vehicle_type in vehicle_types %}
                                <option value="{{ vehicle_type }}">{{ vehicle_type }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label><b>Select the Brand:</b></label>
                            <select class="form-control" id="brand" name="brand" required onchange="updateModels()">
                                <option value="" disabled selected>Select Brand</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><b>Select the Model:</b></label>
                            <select class="form-control" id="model" name="model" required>
                                <option value="" disabled selected>Select Model</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><b>Select the Gearbox:</b></label>
                            <select class="form-control" id="gearbox" name="gearbox" required>
                                <option value="" disabled selected>Select Gearbox</option>
                                {% for gearbox in gearbox_types %}
                                <option value="{{ gearbox }}">{{ gearbox }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label><b>Select the Fuel Type:</b></label>
                            <select class="form-control" id="fuel_type" name="fuel_type" required>
                                <option value="" disabled selected>Select Fuel Type</option>
                                {% for fuel in fuel_types %}
                                <option value="{{ fuel }}">{{ fuel }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label><b>Enter the Power (in kW):</b></label>
                            <input type="number" class="form-control" id="power" name="power"
                                placeholder="Enter power in kW" min="0" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label><b>Enter the Number of Kilometres:</b></label>
                            <input type="number" class="form-control" id="kilometer" name="kilometer"
                                placeholder="Enter kilometers driven" min="0" required>
                        </div>

                        <div class="form-group">
                            <label><b>Has the car been repaired?</b></label>
                            <select class="form-control" id="repaired" name="repaired" required>
                                <option value="" disabled selected>Select Repair Status</option>
                                {% for repaired in repaired_options %}
                                <option value="{{ repaired }}">{{ repaired }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label><b>Enter Postal Code:</b></label>
                            <input type="text" class="form-control" id="postal_code" name="postal_code"
                                placeholder="Enter postal code" pattern="[0-9]{5}"
                                title="Please enter a 5-digit postal code" required>
                        </div>

                        <div class="form-group">
                            <label><b>Enter Registration Month & Year:</b></label>
                            <input type="month" class="form-control" id="registration_year" name="registration_year"
                                required>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-primary btn-block" id="predictButton">Predict
                                Price</button>
                        </div>
                    </form>

                    <div class="result" id="resultContainer" style="display: none;">
                        <h4>Predicted Selling Price:</h4>
                        <div class="price-display">
                            <div class="price-item">
                                <span class="currency">₹</span>
                                <span id="prediction_inr" class="price-amount"></span>
                                <span class="currency-label">INR</span>
                            </div>
                            <div class="price-item">
                                <span class="currency">€</span>
                                <span id="prediction_eur" class="price-amount"></span>
                                <span class="currency-label">EUR</span>
                            </div>
                        </div>
                        <div class="exchange-rate" id="exchangeRate"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from backend
        const vehicleTypeData = JSON.parse('{{ vehicle_type_data | tojson | safe }}');

        function updateBrands() {
            const vehicleTypeSelect = document.getElementById('vehicle_type');
            const brandSelect = document.getElementById('brand');
            const modelSelect = document.getElementById('model');
            const selectedVehicleType = vehicleTypeSelect.value;

            // Clear current options but keep the placeholder
            brandSelect.innerHTML = '<option value="" disabled selected>Select Brand</option>';
            modelSelect.innerHTML = '<option value="" disabled selected>Select Model</option>';

            if (selectedVehicleType && vehicleTypeData[selectedVehicleType]) {
                // Add brands for selected vehicle type
                const brands = Object.keys(vehicleTypeData[selectedVehicleType]);
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandSelect.appendChild(option);
                });
            }
        }

        function updateModels() {
            const vehicleTypeSelect = document.getElementById('vehicle_type');
            const brandSelect = document.getElementById('brand');
            const modelSelect = document.getElementById('model');
            const selectedVehicleType = vehicleTypeSelect.value;
            const selectedBrand = brandSelect.value;

            // Clear current options but keep the placeholder
            modelSelect.innerHTML = '<option value="" disabled selected>Select Model</option>';

            if (selectedVehicleType && selectedBrand &&
                vehicleTypeData[selectedVehicleType] &&
                vehicleTypeData[selectedVehicleType][selectedBrand]) {

                // Add models for selected vehicle type and brand
                vehicleTypeData[selectedVehicleType][selectedBrand].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
        }

        function validateForm() {
            const form = document.getElementById('predictionForm');
            const selects = form.querySelectorAll('select[required]');
            const inputs = form.querySelectorAll('input[required]');

            // Check all select elements
            for (let select of selects) {
                if (!select.value) {
                    const label = select.previousElementSibling ? select.previousElementSibling.textContent : 'this field';
                    alert(`Please select a valid option for ${label}`);
                    select.focus();
                    return false;
                }
            }

            // Check all input elements
            for (let input of inputs) {
                if (!input.value.trim()) {
                    const label = input.previousElementSibling ? input.previousElementSibling.textContent : 'this field';
                    alert(`Please fill in ${label}`);
                    input.focus();
                    return false;
                }
            }

            // Validate postal code format
            const postalCode = document.getElementById('postal_code').value;
            if (!/^\d{5}$/.test(postalCode)) {
                alert('Please enter a valid 5-digit postal code');
                return false;
            }

            // Validate registration year (should be in the past)
            const registrationInput = document.getElementById('registration_year');
            if (registrationInput.value) {
                const selectedDate = new Date(registrationInput.value + '-01');
                const currentDate = new Date();
                if (selectedDate > currentDate) {
                    alert('Registration date cannot be in the future');
                    return false;
                }
            }

            return true;
        }

        function sendData() {
            if (!validateForm()) {
                return;
            }

            const form = document.getElementById('predictionForm');
            const formData = new FormData(form);

            // Show loading state
            const resultContainer = document.getElementById('resultContainer');
            const predictionInrElement = document.getElementById('prediction_inr');
            const predictionEurElement = document.getElementById('prediction_eur');
            const exchangeRateElement = document.getElementById('exchangeRate');

            resultContainer.style.display = 'block';
            predictionInrElement.textContent = "Calculating...";
            predictionEurElement.textContent = "Calculating...";
            exchangeRateElement.textContent = "Processing your request...";

            // Send AJAX request
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        // Try to get error message from response
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || `Server error: ${response.status}`);
                        }).catch(() => {
                            throw new Error(`Server error: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Format numbers with commas for better readability
                    const formatNumber = (num) => {
                        return new Intl.NumberFormat('en-IN').format(num);
                    };

                    predictionInrElement.textContent = formatNumber(data.price_inr);
                    predictionEurElement.textContent = formatNumber(data.price_eur);
                    exchangeRateElement.textContent = `Exchange rate: 1 EUR = ${data.exchange_rate} INR`;

                    // Show success message if present
                    if (data.message && data.message !== 'Success') {
                        exchangeRateElement.textContent += ` | ${data.message}`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    predictionInrElement.textContent = "Error";
                    predictionEurElement.textContent = "Error";
                    exchangeRateElement.textContent = error.message || "Error predicting price. Please try again.";
                });
        }

        // Initialize the form when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            // Load models for default vehicle type if any
            updateBrands();

            // Add event listener to the predict button
            document.getElementById('predictButton').addEventListener('click', sendData);

            // Add change event to all selects to remove any visual indication of invalid state once selected
            const allSelects = document.querySelectorAll('select');
            allSelects.forEach(select => {
                select.addEventListener('change', function () {
                    if (this.value) {
                        this.style.borderColor = '#ccc'; // Reset to normal border color
                    }
                });
            });

            // Add input event to number fields for real-time validation
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('input', function () {
                    if (this.value && this.value > 0) {
                        this.style.borderColor = '#ccc';
                    }
                });
            });
        });
    </script>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>

</html>